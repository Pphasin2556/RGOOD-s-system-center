<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Daily Timeline ‚Äî Internal (Email+Password, Drive, RBAC, Realtime)</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --border:#1f2937; --accent:#22d3ee;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --doing:#f59e0b; --blocked:#ef4444; --pending:#f59e0b; --done:#10b981;
  }
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,#0b1224,#0f172a); color:var(--ink); font-family:'Prompt',system-ui;}
  .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
  header{display:flex; align-items:center; gap:12px; margin-bottom:16px}
  h1{font-size:24px; margin:0}
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .grid{display:grid; gap:12px}
  .two{grid-template-columns:1fr 1fr}
  label{font-size:13px; color:var(--muted)}
  input, textarea, select{width:100%; background:#0b1220; color:var(--ink); border:1px solid var(--border); border-radius:10px; padding:10px 12px}
  textarea{min-height:90px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{background:#0b1220; border:1px solid var(--border); color:var(--ink); padding:10px 14px; border-radius:10px; cursor:pointer}
  .btn:hover{border-color:#334155}
  .btn.primary{background:var(--accent); color:#05202b; border-color:transparent; font-weight:700}
  .tabbar{display:flex; gap:8px; margin:10px 0 16px}
  .tab{cursor:pointer; padding:10px 14px; border-radius:10px; border:1px solid var(--border); color:var(--muted)}
  .tab.active{border-color:var(--accent); color:var(--ink)}
  .pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600}
  .status-done{background:rgba(16,185,129,.12); color:var(--done);}
  .status-doing{background:rgba(245,158,11,.12); color:var(--doing);}
  .status-blocked{background:rgba(239,68,68,.12); color:var(--blocked);}
  .status-pending{background:rgba(245,158,11,.12); color:var(--pending)}
  .timeline{display:grid; gap:12px}
  .item{display:grid; gap:8px; padding:14px; border:1px solid var(--border); border-radius:12px; background:#0b1220}
  .item-head{display:flex; justify-content:space-between; gap:12px}
  .item-meta{font-size:12px; color:var(--muted)}
  .filters{display:grid; gap:10px}
  .filters.two{grid-template-columns:repeat(2,1fr)}
  .right{margin-left:auto}
  .hint{font-size:12px; color:var(--muted)}
  .danger{color:var(--err)} .success{color:var(--ok)}

  /* Plan (Gantt-like) */
  .plan-rows{display:grid; gap:8px}
  .plan-row{display:grid; grid-template-columns:280px 1fr; gap:12px}
  .plan-label{font-size:13px; color:var(--ink)}
  .plan-canvas{position:relative; height:36px; border:1px solid var(--border); border-radius:10px; background:#0b1220; overflow:hidden}
  .bar{position:absolute; top:6px; height:24px; border-radius:8px; border:1px solid rgba(255,255,255,.12)}
  .bar.done{background:rgba(16,185,129,.25);}
  .bar.doing,.bar.pending{background:rgba(245,158,11,.25)}
  .bar.blocked{background:rgba(239,68,68,.25)}
  .plan-axis{display:flex; justify-content:space-between; font-size:11px; color:var(--muted); margin:4px 0 8px}
  .legend{display:flex; gap:10px; align-items:center; font-size:12px; color:var(--muted)}
  .legend span{display:inline-block; width:10px; height:10px; border-radius:3px}
  .lg-done{background:var(--done)} .lg-doing{background:var(--warn)} .lg-blocked{background:var(--err)}
  @media (max-width:900px){ .two{grid-template-columns:1fr} .filters.two{grid-template-columns:1fr} .plan-row{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Daily Timeline ‚Äî Internal (Email+Password, Drive, RBAC, Realtime)</h1>
    <div class="right hint">‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Äî ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
  </header>

  <!-- Auth Card -->
  <div id="authCard" class="card">
    <div class="grid two">
      <div>
        <label>Supabase URL</label>
        <input id="sb-url" placeholder="https://xxxxx.supabase.co">
      </div>
      <div>
        <label>Supabase Anon Key</label>
        <input id="sb-key" placeholder="ey...">
      </div>
    </div>

    <div class="tabbar" style="margin-top:10px">
      <div class="tab active" data-auth="signin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
      <div class="tab" data-auth="signup">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
    </div>

    <div id="signinForm">
      <div class="grid two">
        <div>
          <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
          <input id="emailLogin" placeholder="name@company.com">
        </div>
        <div>
          <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input id="passwordLogin" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <span id="authMsgLogin" class="hint"></span>
      </div>
    </div>

    <div id="signupForm" style="display:none">
      <div class="grid two">
        <div>
          <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ @yourcompany.com)</label>
          <input id="emailSignup" placeholder="name@company.com">
        </div>
        <div>
          <label>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ)</label>
          <input id="passwordSignup" type="password" placeholder="‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô">
        </div>
      </div>
      <div class="hint">* ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‚Äú‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‚Äù ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ</div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnSignup">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
        <span id="authMsgSignup" class="hint"></span>
      </div>
    </div>
  </div>

  <!-- App (‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô) -->
  <div id="appWrap" style="display:none">
    <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
      <div class="hint" id="whoami"></div>
      <div class="row" style="gap:8px">
        <input id="line-webhook" placeholder="LINE Webhook URL (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)" style="min-width:260px">
        <input id="allowed-domain" placeholder="‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÄ‡∏ä‡πà‡∏ô yourcompany.com)" style="min-width:260px">
        <button class="btn" id="btnSaveCfg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å</button>
        <button class="btn" id="btnChangePw">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
        <button class="btn" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>

    <div class="tabbar">
      <div class="tab active" data-tab="post">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô</div>
      <div class="tab" data-tab="feed">‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå</div>
      <div class="tab" data-tab="plan">‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û</div>
    </div>

    <!-- Post Tab -->
    <section id="tab-post" class="card">
      <div class="grid two" style="margin-top:10px">
        <div>
          <label>‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</label>
          <input type="datetime-local" id="eventTime"/>
        </div>
        <div>
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select id="status">
            <option value="doing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option>
            <option value="done">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)</option>
            <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option>
            <option value="blocked">‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡πÅ‡∏î‡∏á)</option>
          </select>
        </div>
        <div>
          <label>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
          <input id="companyName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏≠‡∏≤‡∏£‡πå‡∏Å‡∏π‡πä‡∏î ‡∏à‡∏≥‡∏Å‡∏±‡∏î"/>
        </div>
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
          <input id="documentName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 2 ‚Äî ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏õ‡∏∏‡πã‡∏¢"/>
        </div>
        <div>
          <label>‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏°)</label>
          <input type="date" id="startDate"/>
        </div>
        <div>
          <label>‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î)</label>
          <input type="date" id="dueDate"/>
        </div>
        <div>
          <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
          <input id="title" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 2 ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"/>
        </div>
        <div>
          <label>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
          <input id="assignee" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á / ‡∏ó‡∏µ‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"/>
        </div>
        <div>
          <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
          <input id="dept" placeholder="‡πÄ‡∏ä‡πà‡∏ô Operations"/>
        </div>
        <div>
          <label>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
          <input id="project" placeholder="‡πÄ‡∏ä‡πà‡∏ô R.Good - ‡∏õ‡∏∏‡πã‡∏¢‡∏£‡∏∏‡πà‡∏ô A"/>
        </div>

        <div class="grid" style="grid-template-columns:2fr 1fr; gap:10px">
          <div>
            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label>
            <textarea id="details" placeholder="‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥/‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå/‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ"></textarea>
          </div>
          <div>
            <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå (Google Drive/Docs/Sheets/PDF)</label>
            <input id="driveLink" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ä‡∏£‡πå‡∏à‡∏≤‡∏Å Google Drive">
            <div class="hint">* ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏ô Drive ‡πÄ‡∏õ‡πá‡∏ô ‚ÄúAnyone with the link (Viewer)‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÇ‡∏î‡πÄ‡∏°‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏î‡πâ</div>
          </div>
        </div>

        <div>
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏†‡∏≤‡∏¢‡πÉ‡∏ô</label>
          <input id="adminNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å ‡∏≠‡∏¢."/>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnSubmit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
        <span id="postMsg" class="hint"></span>
      </div>
    </section>

    <!-- Feed Tab -->
    <section id="tab-feed" class="card" style="display:none">
      <div class="filters two">
        <div class="row" style="gap:8px">
          <div style="flex:1">
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
            <input type="date" id="fromDate">
          </div>
          <div style="flex:1">
            <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="toDate">
          </div>
        </div>
        <div class="row" style="gap:8px">
          <input id="qCompany" placeholder="‡∏Å‡∏£‡∏≠‡∏á: ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">
          <input id="qDocument" placeholder="‡∏Å‡∏£‡∏≠‡∏á: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£">
          <input id="qAssignee" placeholder="‡∏Å‡∏£‡∏≠‡∏á: ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö">
          <select id="qStatus">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="doing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option>
            <option value="done">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)</option>
            <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option>
            <option value="blocked">‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡πÅ‡∏î‡∏á)</option>
          </select>
          <button class="btn" id="btnFilter">‡∏Å‡∏£‡∏≠‡∏á</button>
          <button class="btn" id="btnReset">‡∏•‡πâ‡∏≤‡∏á</button>
          <button class="btn" id="btnExport">Export CSV</button>
        </div>
      </div>

      <div class="timeline" id="timeline" style="margin-top:12px"></div>
      <div id="feedMsg" class="hint" style="margin-top:8px"></div>
    </section>

    <!-- Plan Tab -->
    <section id="tab-plan" class="card" style="display:none">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="legend">
          <span class="lg-done"></span> ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß &nbsp;&nbsp;
          <span class="lg-doing"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥/‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ &nbsp;&nbsp;
          <span class="lg-blocked"></span> ‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤
        </div>
        <div class="row" style="gap:8px">
          <input id="pFrom" type="date"/>
          <input id="pTo" type="date"/>
          <input id="pCompany" placeholder="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó"/>
          <input id="pDocument" placeholder="‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"/>
          <select id="pStatus">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="doing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option>
            <option value="done">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)</option>
            <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option>
            <option value="blocked">‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡πÅ‡∏î‡∏á)</option>
          </select>
          <button class="btn" id="btnPlanFilter">‡∏Å‡∏£‡∏≠‡∏á</button>
          <button class="btn" id="btnPlanReset">‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
      </div>

      <div class="plan-rows" id="planRows" style="margin-top:12px"></div>
      <div id="planMsg" class="hint" style="margin-top:8px"></div>
    </section>
  </div>
</div>

<script>
  // ===== Helper: Date/Time TH + ‡∏ï‡∏£‡∏ß‡∏à Drive =====
  function formatThaiDT(dtStr){
    const d = new Date(dtStr); if(isNaN(d)) return '';
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear()+543;
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${dd}/${mm}/${yy} ${hh}:${mi}`;
  }
  function formatThaiD(dStr){
    const d = new Date(dStr); if(isNaN(d)) return '';
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear()+543;
    return `${dd}/${mm}/${yy}`;
  }
  function statusPill(status){
    const map = {done:'status-done', doing:'status-doing', blocked:'status-blocked', pending:'status-pending'};
    const label = {done:'‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', doing:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥', blocked:'‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤', pending:'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}[status] || status;
    return `<span class="pill ${map[status]||'status-doing'}">${label}</span>`;
  }
  function isDriveLink(url){ return /https?:\/\/(drive\.google\.com|docs\.google\.com)/i.test(url||''); }
  function toDrivePreview(url){
    if(!url) return '';
    const m = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    if(m) return `https://drive.google.com/file/d/${m[1]}/preview`;
    if(url.includes('docs.google.com')) return url.replace(/\/edit.*$/,'/pub?embedded=true');
    return url;
  }

  // ===== State =====
  let supabaseClient = null;
  let LINE_WEBHOOK_URL = '';
  let ALLOWED_EMAIL_DOMAIN = '';
  let currentRole = 'staff';
  let currentUserId = null;
  let realtimeChannel = null;

  // ===== UI elts =====
  const authCard = document.getElementById('authCard');
  const appWrap = document.getElementById('appWrap');
  const whoami = document.getElementById('whoami');

  // Auth tabs
  document.querySelectorAll('.tab[data-auth]').forEach(t=>{
    t.addEventListener('click',()=>{
      document.querySelectorAll('.tab[data-auth]').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const mode = t.getAttribute('data-auth');
      document.getElementById('signinForm').style.display = (mode==='signin')?'block':'none';
      document.getElementById('signupForm').style.display = (mode==='signup')?'block':'none';
    });
  });

  // App tabs
  document.querySelectorAll('.tab[data-tab]').forEach(t=>t.addEventListener('click',()=>{
    document.querySelectorAll('.tab[data-tab]').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const tab = t.dataset.tab;
    document.getElementById('tab-post').style.display = (tab==='post')?'block':'none';
    document.getElementById('tab-feed').style.display = (tab==='feed')?'block':'none';
    document.getElementById('tab-plan').style.display = (tab==='plan')?'block':'none';
    if(tab==='feed') loadFeed();
    if(tab==='plan') loadPlan();
  }));

  // ===== Bootstrap client from localStorage =====
  function createClientFromStorage(){
    const url = localStorage.getItem('SB_URL')||'';
    const key = localStorage.getItem('SB_KEY')||'';
    document.getElementById('sb-url').value = url;
    document.getElementById('sb-key').value = key;
    if(url && key){ supabaseClient = window.supabase.createClient(url, key); }
  }
  createClientFromStorage();

  function loadLocalCfg(){
    LINE_WEBHOOK_URL = localStorage.getItem('LINE_WEBHOOK_URL')||'';
    ALLOWED_EMAIL_DOMAIN = localStorage.getItem('ALLOWED_EMAIL_DOMAIN')||'';
    document.getElementById('line-webhook').value = LINE_WEBHOOK_URL;
    document.getElementById('allowed-domain').value = ALLOWED_EMAIL_DOMAIN;
  }
  loadLocalCfg();

  function showAuth(){ authCard.style.display='block'; appWrap.style.display='none'; }
  function showApp(){ authCard.style.display='none'; appWrap.style.display='block'; }

  async function loadRole(){
    const { data:{ user } } = await (supabaseClient?.auth.getUser() || {});
    if(!user) return;
    currentUserId = user.id;
    const { data, error } = await supabaseClient.from('profiles').select('role, display_name, dept').eq('id', user.id).single();
    if(!error && data){ currentRole = data.role||'staff'; }
    whoami.textContent = `‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ: ${user.email} ‚Äî ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ${currentRole}`;
  }

  function subscribeRealtime(){
    if(realtimeChannel || !supabaseClient) return;
    realtimeChannel = supabaseClient
      .channel('realtime:timeline_entries')
      .on('postgres_changes', {event:'*', schema:'public', table:'timeline_entries'}, ()=>{
        const visFeed = document.getElementById('tab-feed').style.display !== 'none';
        const visPlan = document.getElementById('tab-plan').style.display !== 'none';
        if(visFeed) loadFeed(); if(visPlan) loadPlan();
      })
      .subscribe();
  }
  function unsubscribeRealtime(){
    if(realtimeChannel){ supabaseClient.removeChannel(realtimeChannel); realtimeChannel = null; }
  }

  async function refreshSession(){
    if(!supabaseClient){ showAuth(); return; }
    const { data:{ session } } = await supabaseClient.auth.getSession();
    if(session){ await loadRole(); subscribeRealtime(); showApp(); }
    else { unsubscribeRealtime(); showAuth(); }
  }
  refreshSession();
  if(supabaseClient){ supabaseClient.auth.onAuthStateChange(()=>{ refreshSession(); }); }

  // ===== Save config =====
  document.getElementById('btnSaveCfg').addEventListener('click',()=>{
    LINE_WEBHOOK_URL = document.getElementById('line-webhook').value.trim();
    ALLOWED_EMAIL_DOMAIN = document.getElementById('allowed-domain').value.trim();
    localStorage.setItem('LINE_WEBHOOK_URL', LINE_WEBHOOK_URL);
    localStorage.setItem('ALLOWED_EMAIL_DOMAIN', ALLOWED_EMAIL_DOMAIN);
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
  });

  // ===== Change password =====
  document.getElementById('btnChangePw').addEventListener('click', async ()=>{
    const pw = prompt('‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:');
    if(!pw) return;
    const { error } = await supabaseClient.auth.updateUser({ password: pw });
    if(error) alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+error.message);
    else alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  });

  // ===== Auth: Login / Signup =====
  document.getElementById('btnLogin').addEventListener('click', async ()=>{
    const url = document.getElementById('sb-url').value.trim();
    const key = document.getElementById('sb-key').value.trim();
    const email = document.getElementById('emailLogin').value.trim();
    const password = document.getElementById('passwordLogin').value;
    const msg = document.getElementById('authMsgLogin');
    if(!url || !key || !email || !password){ msg.innerHTML = '<span class="danger">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô</span>'; return; }
    localStorage.setItem('SB_URL', url); localStorage.setItem('SB_KEY', key);
    supabaseClient = window.supabase.createClient(url, key);
    try{
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if(error) throw error;
      msg.innerHTML = '<span class="success">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>';
      refreshSession();
    }catch(e){ msg.innerHTML = '<span class="danger">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)+'</span>'; }
  });

  document.getElementById('btnSignup').addEventListener('click', async ()=>{
    const url = document.getElementById('sb-url').value.trim();
    const key = document.getElementById('sb-key').value.trim();
    const email = document.getElementById('emailSignup').value.trim();
    const password = document.getElementById('passwordSignup').value;
    const msg = document.getElementById('authMsgSignup');
    if(!url || !key || !email || !password){ msg.innerHTML = '<span class="danger">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô</span>'; return; }
    const dom = (ALLOWED_EMAIL_DOMAIN||'').toLowerCase();
    if(dom && !email.toLowerCase().endsWith('@'+dom)){ msg.innerHTML = '<span class="danger">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ @'+dom+'</span>'; return; }
    localStorage.setItem('SB_URL', url); localStorage.setItem('SB_KEY', key);
    supabaseClient = window.supabase.createClient(url, key);
    try{
      const { error } = await supabaseClient.auth.signUp({ email, password });
      if(error) throw error;
      msg.innerHTML = '<span class="success">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö ‚Äú‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Äù</span>';
      alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö ‚Äú‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ');
    }catch(e){ msg.innerHTML = '<span class="danger">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)+'</span>'; }
  });

  document.getElementById('btnLogout').addEventListener('click', async ()=>{
    if(supabaseClient) await supabaseClient.auth.signOut();
  });

  // ===== LINE webhook (optional) =====
  async function callLineWebhook(payload){
    if(!LINE_WEBHOOK_URL) return;
    try{ await fetch(LINE_WEBHOOK_URL,{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});}catch(e){}
  }

  // ===== Create (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï) =====
  document.getElementById('btnSubmit').addEventListener('click', async ()=>{
    const msg = document.getElementById('postMsg'); msg.textContent = '';
    const { data:{ session } } = await supabaseClient.auth.getSession(); if(!session){ msg.innerHTML='<span class="danger">‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô</span>'; return; }

    const eventTime = document.getElementById('eventTime').value;
    const title = document.getElementById('title').value.trim();
    const details = document.getElementById('details').value.trim();
    const status = document.getElementById('status').value;
    const assignee = document.getElementById('assignee').value.trim();
    const dept = document.getElementById('dept').value.trim();
    const project = document.getElementById('project').value.trim();
    const adminNote = document.getElementById('adminNote').value.trim();
    const company_name = document.getElementById('companyName').value.trim();
    const document_name = document.getElementById('documentName').value.trim();
    const sd = document.getElementById('startDate').value;
    const dd = document.getElementById('dueDate').value;
    const drive_link = document.getElementById('driveLink').value.trim();

    if(!eventTime || !title){ msg.innerHTML='<span class="danger">‡∏Å‡∏£‡∏≠‡∏Å "‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤" ‡πÅ‡∏•‡∏∞ "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"</span>'; return; }

    try{
      const payload = {
        event_time:new Date(eventTime).toISOString(), title, details, status, assignee, dept, project,
        admin_note: adminNote,
        company_name: company_name || null, document_name: document_name || null,
        start_date: sd? new Date(sd+'T00:00:00').toISOString() : null,
        due_date: dd? new Date(dd+'T23:59:59').toISOString() : null,
        drive_link: drive_link || null
      };
      const { error } = await supabaseClient.from('timeline_entries').insert(payload);
      if(error) throw error; msg.innerHTML = '<span class="success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì</span>';
      ['title','details','adminNote','companyName','documentName','driveLink'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      document.getElementById('startDate').value=''; document.getElementById('dueDate').value='';
      callLineWebhook({ type:'timeline.new', title, status, assignee, dept, project, company_name, document_name, event_time: payload.event_time, drive_link });
    }catch(e){ msg.innerHTML = '<span class="danger">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+ (e.message||e) +'</span>'; }
  });

  // ===== Feed (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏•‡∏ö ‡∏ï‡∏≤‡∏° RBAC) =====
  window.appDelete = async function(id){
    if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
    const { error } = await supabaseClient.from('timeline_entries').delete().eq('id', id);
    if(error) alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+error.message); else loadFeed();
  };
  window.appSaveStatus = async function(id){
    const sel = document.getElementById('st-'+id); const ns = sel?.value; if(!ns) return;
    const { error } = await supabaseClient.from('timeline_entries').update({status:ns}).eq('id', id);
    if(error) alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+error.message); else loadFeed();
  };

  function renderDrivePreview(link){
    if(!link) return '';
    const safe = link.replace(/"/g,'&quot;');
    if(isDriveLink(link)){
      const prev = toDrivePreview(link);
      if(prev && prev!==link){
        return `
          <div class="item-meta">‡πÑ‡∏ü‡∏•‡πå: <a href="${safe}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà</a></div>
          <iframe src="${prev}" style="width:100%; height:360px; border:1px solid var(--border); border-radius:10px; background:#000" allow="autoplay"></iframe>
        `;
      }
    }
    return `<div class="item-meta">‡πÑ‡∏ü‡∏•‡πå: <a href="${safe}" target="_blank" rel="noopener">${safe}</a></div>`;
  }

  async function loadFeed(){
    const wrap = document.getElementById('timeline'); const msg = document.getElementById('feedMsg'); wrap.innerHTML=''; msg.textContent='';
    const { data:{ session } } = await supabaseClient.auth.getSession(); if(!session){ msg.innerHTML='<span class="danger">‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</span>'; return; }

    let query = supabaseClient.from('timeline_entries').select('*').order('event_time', { ascending:false }).limit(300);
    const f = document.getElementById('fromDate').value; const t = document.getElementById('toDate').value;
    const qCompany = document.getElementById('qCompany').value.trim(); const qDocument = document.getElementById('qDocument').value.trim();
    const qAssignee = document.getElementById('qAssignee').value.trim(); const qStatus = document.getElementById('qStatus').value;
    if(f) query = query.gte('event_time', new Date(f+'T00:00:00').toISOString());
    if(t) query = query.lte('event_time', new Date(t+'T23:59:59').toISOString());
    if(qCompany) query = query.ilike('company_name', `%${qCompany}%`);
    if(qDocument) query = query.ilike('document_name', `%${qDocument}%`);
    if(qAssignee) query = query.ilike('assignee', `%${qAssignee}%`);
    if(qStatus) query = query.eq('status', qStatus);

    const { data, error } = await query; if(error){ msg.innerHTML = '<span class="danger">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+error.message+'</span>'; return; }
    if(!data || !data.length){ msg.textContent = '‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî'; return; }

    await loadRole();

    for(const r of data){
      const canEdit = (currentRole==='admin') || (r.created_by === currentUserId);
      const meta1 = [r.company_name?`‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${r.company_name}`:null, r.document_name?`‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${r.document_name}`:null].filter(Boolean).join(' ¬∑ ');
      const meta2 = [r.assignee?`‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${r.assignee}`:null, r.dept?`‡πÅ‡∏ú‡∏ô‡∏Å: ${r.dept}`:null, r.project?`‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: ${r.project}`:null].filter(Boolean).join(' ¬∑ ');
      const plan = (r.start_date||r.due_date) ? `‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏ú‡∏ô: ${(r.start_date?formatThaiD(r.start_date):'-')} ‚Äî ${(r.due_date?formatThaiD(r.due_date):'-')}` : '';
      const drive = r.drive_link ? renderDrivePreview(r.drive_link) : '';
      const controls = canEdit ? `
        <div class="row" style="gap:8px; margin-top:6px">
          <select id="st-${r.id}">
            <option value="doing" ${r.status==='doing'?'selected':''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>
            <option value="done" ${r.status==='done'?'selected':''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="pending" ${r.status==='pending'?'selected':''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="blocked" ${r.status==='blocked'?'selected':''}>‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</option>
          </select>
          <button class="btn" onclick="appSaveStatus('${r.id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
          <button class="btn" onclick="appDelete('${r.id}')">‡∏•‡∏ö</button>
        </div>` : '';

      const html = `
        <div class="item">
          <div class="item-head">
            <div><strong>${r.title||'-'}</strong></div>
            <div class="item-meta">${formatThaiDT(r.event_time)} ${statusPill(r.status)}</div>
          </div>
          ${ meta1 ? `<div class="item-meta">${meta1}</div>`:'' }
          ${ meta2 ? `<div class="item-meta">${meta2}</div>`:'' }
          ${ plan ? `<div class="item-meta">${plan}</div>`:'' }
          ${ r.details ? `<div>${r.details}</div>`:'' }
          ${ drive }
          ${ controls }
        </div>`;
      wrap.insertAdjacentHTML('beforeend', html);
      if(drive){ await new Promise(res=>setTimeout(res,0)); } // ‡πÉ‡∏´‡πâ iframe ‡∏ß‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    }
    msg.textContent = `‡πÅ‡∏™‡∏î‡∏á ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  }

  // ===== Plan (Gantt-like) =====
  function daysBetween(a,b){ const MS=24*3600*1000; return Math.max(0, Math.round((b-a)/MS)); }
  async function loadPlan(){
    const box = document.getElementById('planRows'); const msg = document.getElementById('planMsg'); box.innerHTML=''; msg.textContent='';
    const { data:{ session } } = await supabaseClient.auth.getSession(); if(!session){ msg.innerHTML='<span class="danger">‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</span>'; return; }

    let query = supabaseClient.from('timeline_entries').select('*').order('due_date', {ascending:true}).limit(400);
    const f = document.getElementById('pFrom').value; const t = document.getElementById('pTo').value; const c = document.getElementById('pCompany').value.trim(); const d = document.getElementById('pDocument').value.trim(); const s = document.getElementById('pStatus').value;
    if(f) query = query.gte('event_time', new Date(f+'T00:00:00').toISOString());
    if(t) query = query.lte('event_time', new Date(t+'T23:59:59').toISOString());
    if(c) query = query.ilike('company_name', `%${c}%`);
    if(d) query = query.ilike('document_name', `%${d}%`);
    if(s) query = query.eq('status', s);

    const { data, error } = await query; if(error){ msg.innerHTML = '<span class="danger">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+error.message+'</span>'; return; }
    if(!data || !data.length){ msg.textContent = '‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî'; return; }

    let minT = Infinity, maxT = -Infinity; const MS=24*3600*1000;
    for(const r of data){
      const sT = r.start_date ? new Date(r.start_date).getTime() : (r.event_time? new Date(r.event_time).getTime():null);
      const eT = r.due_date ? new Date(r.due_date).getTime() : sT;
      if(sT!=null){ minT = Math.min(minT, sT); }
      if(eT!=null){ maxT = Math.max(maxT, eT); }
    }
    if(!isFinite(minT) || !isFinite(maxT)){ msg.textContent='‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‚Äî'; return; }
    minT -= MS; maxT += MS; const totalDays = Math.max(1, Math.round((maxT-minT)/MS));

    const axis = document.createElement('div'); axis.className='plan-axis';
    axis.innerHTML = `<div>${formatThaiD(new Date(minT))}</div><div>${formatThaiD(new Date(maxT))}</div>`;
    box.appendChild(axis);

    for(const r of data){
      const row = document.createElement('div'); row.className='plan-row';
      const label = document.createElement('div'); label.className='plan-label';
      const comp = r.company_name? `‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${r.company_name}`:''; const doc = r.document_name? `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${r.document_name}`:'';
      label.innerHTML = `<strong>${r.title||'-'}</strong><div class="hint">${[comp,doc].filter(Boolean).join(' ¬∑ ')||'‚Äî'}</div>`;

      const canvas = document.createElement('div'); canvas.className='plan-canvas';
      const sT = r.start_date ? new Date(r.start_date).getTime() : (r.event_time? new Date(r.event_time).getTime():minT);
      const eT = r.due_date ? new Date(r.due_date).getTime() : sT;
      const startDay = Math.min(totalDays, Math.max(0, Math.round((sT - minT)/MS)));
      const durDays = Math.max(1, daysBetween(sT, eT) + 1);
      const bar = document.createElement('div'); bar.className = `bar ${r.status||'doing'}`;

      const observer = new ResizeObserver(()=>{
        const W = canvas.clientWidth;
        const left = (startDay/totalDays) * W;
        const width = (durDays/totalDays) * W;
        bar.style.left = `${left}px`; bar.style.width = `${Math.max(8,width)}px`;
      });
      observer.observe(canvas);
      canvas.appendChild(bar);

      row.appendChild(label);
      row.appendChild(canvas);
      box.appendChild(row);
    }
    msg.textContent = `‡∏£‡∏ß‡∏° ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  }

  // ===== Filter buttons =====
  document.getElementById('btnFilter').addEventListener('click', loadFeed);
  document.getElementById('btnReset').addEventListener('click',()=>{
    ['fromDate','toDate','qCompany','qDocument','qAssignee','qStatus'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    loadFeed();
  });
  document.getElementById('btnPlanFilter').addEventListener('click', loadPlan);
  document.getElementById('btnPlanReset').addEventListener('click',()=>{
    ['pFrom','pTo','pCompany','pDocument','pStatus'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    loadPlan();
  });

  // ===== Export CSV =====
  document.getElementById('btnExport').addEventListener('click', async()=>{
    const { data:{ session } } = await supabaseClient.auth.getSession(); if(!session){ alert('‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô'); return; }
    const { data, error } = await supabaseClient.from('timeline_entries').select('*').order('event_time', {ascending:true});
    if(error){ alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+error.message); return; }
    const header = ['event_time','title','details','status','assignee','dept','project','company_name','document_name','start_date','due_date','drive_link'];
    const rows = [header.join(',')].concat((data||[]).map(r=>[
      r.event_time, JSON.stringify(r.title||''), JSON.stringify(r.details||''), r.status,
      JSON.stringify(r.assignee||''), JSON.stringify(r.dept||''), JSON.stringify(r.project||''),
      JSON.stringify(r.company_name||''), JSON.stringify(r.document_name||''), r.start_date||'', r.due_date||'',
      JSON.stringify(r.drive_link||'')
    ].join(','))).join('\n');
    const blob = new Blob([rows],{type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'timeline_export.csv'; a.click();
  });

  // ===== Default now =====
  (function presetNow(){
    const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    const el=document.getElementById('eventTime'); if(el) el.value = now.toISOString().slice(0,16);
  })();
</script>
  <!-- ==== EASY MODE ADD-ON (‡∏ß‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô </body>) ==== -->
<style>
  /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πÄ‡∏Å‡∏•‡∏≠‡∏á‡∏Ñ‡πå‡∏£‡∏ß‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ --scale */
  html{ font-size: calc(16px * var(--scale, 1)); }
  /* ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å */
  body.easy-mode .item{ padding:20px }
  body.easy-mode input, body.easy-mode select, body.easy-mode textarea, body.easy-mode .btn{
    font-size:1.1rem; padding:14px 16px;
  }
  body.easy-mode .tab{ font-size:1rem }
  body.easy-mode label{ font-size:1rem }
  body.easy-mode .pill{ font-size:1rem; padding:6px 10px }

  /* ‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå‡∏™‡∏π‡∏á */
  body.hc-mode{ color:#fff; background:#000 }
  body.hc-mode .card{ background:#000; border-color:#fff }
  body.hc-mode input, body.hc-mode select, body.hc-mode textarea{ background:#000; color:#fff; border-color:#fff }
  body.hc-mode .btn{ background:#000; color:#fff; border-color:#fff }
  body.hc-mode .tab{ border-color:#fff; color:#fff }
  body.hc-mode .plan-canvas{ background:#000; border-color:#fff }
  body.hc-mode .item{ background:#000; border-color:#fff }
</style>

<script>
(function(){
  // ===== ‡πÅ‡∏ó‡∏£‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà header ‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ =====
  const header = document.querySelector('header');
  if(header){
    const controls = document.createElement('div');
    controls.className = 'row';
    controls.style.marginLeft = 'auto';
    controls.innerHTML = `
      <button class="btn" id="btnEasy">‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢</button>
      <button class="btn" id="btnHC">‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå‡∏™‡∏π‡∏á</button>
      <div class="row" style="gap:6px">
        <button class="btn" id="Aminus" title="‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á">A‚àí</button>
        <button class="btn" id="Aplus"  title="‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô">A+</button>
      </div>
    `;
    header.appendChild(controls);
  }

  // ===== ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á =====
  let scale = parseFloat(localStorage.getItem('UI_SCALE') || '1') || 1;
  document.documentElement.style.setProperty('--scale', scale);
  if(localStorage.getItem('EASY_MODE')) document.body.classList.add('easy-mode');
  if(localStorage.getItem('HC_MODE'))   document.body.classList.add('hc-mode');

  // ===== ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ï‡πà‡∏≤‡∏á ‡πÜ =====
  const btnEasy = document.getElementById('btnEasy');
  const btnHC   = document.getElementById('btnHC');
  const Aminus  = document.getElementById('Aminus');
  const Aplus   = document.getElementById('Aplus');

  btnEasy && (btnEasy.onclick = ()=>{
    document.body.classList.toggle('easy-mode');
    localStorage.setItem('EASY_MODE', document.body.classList.contains('easy-mode') ? '1' : '');
  });
  btnHC && (btnHC.onclick = ()=>{
    document.body.classList.toggle('hc-mode');
    localStorage.setItem('HC_MODE', document.body.classList.contains('hc-mode') ? '1' : '');
  });
  Aplus && (Aplus.onclick = ()=>{
    scale = Math.min(1.8, scale + 0.1);
    document.documentElement.style.setProperty('--scale', scale);
    localStorage.setItem('UI_SCALE', scale);
  });
  Aminus && (Aminus.onclick = ()=>{
    scale = Math.max(0.9, scale - 0.1);
    document.documentElement.style.setProperty('--scale', scale);
    localStorage.setItem('UI_SCALE', scale);
  });

  // ===== ‡∏õ‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢ =====
  const months = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
  window.formatThaiDT = function(dtStr){
    const d = new Date(dtStr); if(isNaN(d)) return '';
    const day = d.getDate();
    const month = months[d.getMonth()];
    const year = d.getFullYear() + 543;
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    if(document.body.classList.contains('easy-mode')){
      return `${day} ${month} ${year} ‡πÄ‡∏ß‡∏•‡∏≤ ${hh}:${mm} ‡∏ô.`;
    }
    return `${String(day).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${year} ${hh}:${mm}`;
  };

  // ===== ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÑ‡∏ó‡∏¢‡∏ä‡∏±‡∏î ‡πÜ =====
  window.statusPill = function(status){
    const mapCls = {done:'status-done', doing:'status-doing', blocked:'status-blocked', pending:'status-pending'};
    const mapTxt = {done:'‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', doing:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥', blocked:'‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤', pending:'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'};
    const mapEmoji = {done:'‚úÖ', doing:'üü°', blocked:'üî¥', pending:'üü°'};
    const label = mapTxt[status] || status;
    const em = mapEmoji[status] || '';
    const showEmoji = document.body.classList.contains('easy-mode');
    return `<span class="pill ${mapCls[status]||'status-doing'}">${showEmoji ? (em+' '+label) : label}</span>`;
  };
})();
</script>
<!-- ==== /EASY MODE ADD-ON ==== -->

</body>
</html>
